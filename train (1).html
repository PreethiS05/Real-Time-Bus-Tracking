<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sarathi Rail ‚Äì Real-time Train Tracking (Punjab Demo)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    html, body { height: 100%; }
    #map { height: 100vh; width: 100%; }
    .panel { position: fixed; top: 0; right: -420px; width: 420px; height: 100vh; background: #fff; box-shadow: -2px 0 12px rgba(0,0,0,.12); transition: right .3s ease; z-index: 1000; overflow-y: auto; }
    .panel.open { right: 0; }
    @media (max-width: 640px){ .panel{ width:100%; right:-100%; } }
    .train-icon { transition: transform .4s linear; }
    .test-badge { font-size: 10px; padding: 2px 6px; border-radius: 8px; }
  </style>
  <style>
  /* Force all common text elements to be dark gray */
  body, h1, h2, h3, h4, h5, h6, p, a, label, select, option, button, span {
    color: #1f2937 !important;  /* Tailwind gray-800 */
  }
</style>

</head>
<script>
  // Global labels store
  const labels = {};

  // Simple translation function
  function t(key) { return labels[key] || key; }

  // Load language JSON
  async function loadLanguage(lang) {
    try {
      const res = await fetch(`lang/${lang}.json`);
      if (!res.ok) throw new Error(`Missing ${lang}.json`);
      const data = await res.json();
      Object.assign(labels, data);
      applyTranslations();
    } catch (err) {
      console.error('Language load failed:', err);
    }
  }

  // Apply translations to page elements
  function applyTranslations() {
    // Buttons
    document.getElementById('locate-me').innerHTML = `<i class="fa-solid fa-location-crosshairs mr-1"></i>${t('locateMe')}`;
    document.getElementById('find-shortest-route')?.innerHTML = `<i class="fa-solid fa-route mr-1"></i>${t('nearestStop')}`;
    document.getElementById('nearest-station')?.innerHTML = `<i class="fa-solid fa-route mr-1"></i>${t('nearestStation')}`;
    document.getElementById('open-complaint').innerHTML = `<i class="fa-regular fa-comment-dots mr-1"></i>${t('complaint')}`;
    document.getElementById('toggle-offline').innerHTML = `<i class="fa-solid fa-signal mr-1"></i>${t('statusOffline') || 'Go Offline'}`;

    // Complaint modal labels
    document.querySelector('label[for="cmp-gender"]').textContent = t('gender');
    document.querySelector('label[for="cmp-category"]').textContent = t('category');
    document.querySelector('label[for="cmp-desc"]').textContent = t('description');
    document.querySelector('#cancel-complaint').textContent = t('cancel');
    document.querySelector('#complaint-form button[type="submit"]').textContent = t('submit');

    // Display board heading
    document.querySelector('#display-board .font-semibold')?.textContent = t('displayBoard');
  }

  // Language switcher (optional: add a <select> in your header)
  const langSelect = document.createElement('select');
  langSelect.id = 'lang-select';
  langSelect.className = 'ml-2 border rounded px-2 py-1';
  langSelect.innerHTML = `<option value="en">English</option><option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option>`;
  document.querySelector('header').appendChild(langSelect);

  langSelect.addEventListener('change', e => loadLanguage(e.target.value));

  // Load default language
  loadLanguage('en');
</script>

<body class="overflow-hidden">
  <!-- Header -->
  <header class="fixed top-0 left-0 right-0 bg-indigo-700 text-white px-3 py-2 flex flex-wrap gap-2 items-center z-10">
    <h1 class="text-lg sm:text-xl font-bold"><i class="fa-solid fa-train-subway mr-2"></i>Sarathi Rail Punjab</h1>

    <div class="flex items-center gap-2 ml-auto">
      <!-- Line Filter -->
      <div class="relative">
        <select id="line-filter" class="bg-indigo-800 text-white px-3 py-1 rounded-md pr-8 cursor-pointer">
          <option value="all">All Lines</option>
          <option value="lineA">Amritsar ‚Üî Chandigarh (via Jalandhar, Ludhiana, Ambala)</option>
          <option value="lineB">Ludhiana ‚Üî Patiala (via Rajpura)</option>
          <option value="lineC">Bathinda ‚Üî Ludhiana (via Mansa, Barnala)</option>
        </select>
        <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2">
          <i class="fa-solid fa-chevron-down"></i>
        </div>
      </div>

      <!-- Station (Display Board) -->
      <div class="relative">
        <select id="station-select" class="bg-emerald-700 text-white px-3 py-1 rounded-md pr-8 cursor-pointer min-w-[260px]" aria-label="Choose station">
          <option value="">Station Display: choose a station‚Ä¶</option>
        </select>
        <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2"><i class="fa-solid fa-location-dot"></i></div>
      </div>

      <!-- Locate -->
      <button id="locate-me" class="bg-indigo-800 hover:bg-indigo-900 px-3 py-1 rounded-md">
        <i class="fa-solid fa-location-crosshairs mr-1"></i><span class="hidden sm:inline">Locate Me</span>
      </button>

      <!-- Nearest Station -->
      <button id="nearest-station" class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md">
        <i class="fa-solid fa-route mr-1"></i><span class="hidden sm:inline">Nearest Station</span>
      </button>

      <!-- Offline -->
      <button id="toggle-offline" class="bg-amber-500 hover:bg-amber-600 px-3 py-1 rounded-md">
        <i class="fa-solid fa-signal mr-1"></i><span class="hidden sm:inline">Go Offline</span>
      </button>

      <!-- Service/Complaint -->
      <button id="open-complaint" class="bg-rose-600 hover:bg-rose-700 px-3 py-1 rounded-md">
        <i class="fa-regular fa-comment-dots mr-1"></i><span class="hidden sm:inline">Service</span>
      </button>

      <!-- Tests -->
      <button id="run-tests" class="bg-slate-800 hover:bg-slate-900 px-3 py-1 rounded-md" title="Run built-in tests">
        <i class="fa-solid fa-flask-vial mr-1"></i>Tests
      </button>
    </div>
  </header>

  <!-- Map -->
  <div id="map" class="z-0"></div>

  <!-- Train Details -->
  <aside id="details-panel" class="panel p-4 pt-16">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-xl font-bold">Train Details</h2>
      <button id="close-panel" class="text-gray-500 hover:text-gray-700" aria-label="Close details"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    <div id="train-info" class="space-y-4"></div>
  </aside>

  <!-- Station Display Board -->
  <div id="display-board" class="hidden fixed left-2 top-16 bg-white rounded-xl shadow-lg border w-[420px] max-w-[92vw] z-[999]" aria-live="polite">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <div class="font-semibold">Station Display</div>
      <button id="close-board" class="text-gray-500 hover:text-gray-700" aria-label="Close station display"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div id="board-body" class="p-3 space-y-2 text-sm"></div>
  </div>

  <!-- Service/Complaint Modal (with Gender-Based allocation) -->
  <div id="complaint-modal" class="hidden fixed inset-0 bg-black/40 z-[1001] flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="cmp-title">
    <div class="bg-white rounded-xl w-full max-w-lg shadow-xl">
      <div class="px-4 py-3 border-b flex justify-between items-center">
        <h3 id="cmp-title" class="font-semibold">Request Service / Lodge Complaint</h3>
        <button id="close-complaint" class="text-gray-500 hover:text-gray-700" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <form id="complaint-form" class="p-4 grid gap-3">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm" for="cmp-name">Name</label>
            <input required id="cmp-name" class="mt-1 w-full border rounded-md px-3 py-2" placeholder="Your name"/>
          </div>
          <div>
            <label class="text-sm" for="cmp-gender">Gender</label>
            <select id="cmp-gender" class="mt-1 w-full border rounded-md px-3 py-2" aria-label="Select gender">
              <option value="female">Female</option>
              <option value="male">Male</option>
              <option value="other">Other / Prefer not to say</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="text-sm" for="cmp-line">Rail Line</label>
            <select id="cmp-line" class="mt-1 w-full border rounded-md px-3 py-2"></select>
          </div>
          <div>
            <label class="text-sm" for="cmp-station">Station</label>
            <select id="cmp-station" class="mt-1 w-full border rounded-md px-3 py-2"></select>
          </div>
        </div>

        <div>
          <label class="text-sm" for="cmp-category">Service Category</label>
          <select id="cmp-category" class="mt-1 w-full border rounded-md px-3 py-2">
            <option value="safety">Safety/Escort</option>
            <option value="medical">Medical Aid</option>
            <option value="assistance">Assistance (boarding, luggage)</option>
            <option value="cleanliness">Cleanliness/Seat Issue</option>
            <option value="coach">Women Coach Request</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div>
          <label class="text-sm" for="cmp-desc">Description</label>
          <textarea required id="cmp-desc" class="mt-1 w-full border rounded-md px-3 py-2" rows="3" placeholder="Describe the issue or service needed"></textarea>
        </div>

        <div class="flex items-center gap-2">
          <input id="cmp-allow-contact" type="checkbox" class="h-4 w-4"/>
          <label for="cmp-allow-contact" class="text-sm">Allow support to contact me</label>
        </div>

        <div class="flex justify-between items-center gap-2 mt-2">
          <p class="text-xs text-slate-500">
            Note: Requests from <b>Female</b> passengers prefer a <b>less-crowded next arriving train</b> at the selected station.
          </p>
          <div class="flex gap-2">
            <button type="button" id="cancel-complaint" class="px-4 py-2 rounded-md border">Cancel</button>
            <button type="submit" class="px-4 py-2 rounded-md bg-rose-600 text-white">Submit</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Tests -->
  <div id="test-panel" class="hidden fixed right-2 bottom-2 bg-white border rounded-lg shadow p-3 w-[360px] max-w-[90vw] z-[1003]">
    <div class="flex items-center justify-between mb-2">
      <div class="font-semibold">Self-Tests</div>
      <button id="test-close" class="text-gray-500 hover:text-gray-700" aria-label="Close tests"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <ul id="test-list" class="space-y-1 text-sm"></ul>
  </div>

  <script>
    /******** 0) Map ********/
    const map = L.map('map').setView([30.9, 75.85], 8.25);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

    /******** 1) Rail Lines (simplified) ********/
    const railLines = {
      lineA: { // Amritsar -> Chandigarh
        name: 'Amritsar ‚Üî Chandigarh',
        color: '#ef4444',
        path: [
          [31.6340,74.8723],   // Amritsar
          [31.3260,75.5762],   // Jalandhar
          [30.9010,75.8573],   // Ludhiana
          [30.3782,76.7800],   // Ambala Cantt (approx)
          [30.7333,76.7794]    // Chandigarh
        ],
        stations: [
          {name:'Amritsar Jn', position:[31.6340,74.8723]},
          {name:'Jalandhar City', position:[31.3260,75.5762]},
          {name:'Ludhiana Jn', position:[30.9010,75.8573]},
          {name:'Ambala Cantt', position:[30.3782,76.7800]},
          {name:'Chandigarh', position:[30.7333,76.7794]}
        ],
        checkpoints: [[31.45,75.2],[30.64,76.3]]
      },
      lineB: { // Ludhiana -> Patiala via Rajpura
        name: 'Ludhiana ‚Üî Patiala',
        color: '#10b981',
        path: [
          [30.9010,75.8573],  // Ludhiana
          [30.4833,76.5939],  // Rajpura
          [30.3398,76.3869]   // Patiala
        ],
        stations: [
          {name:'Ludhiana Jn', position:[30.9010,75.8573]},
          {name:'Rajpura Jn', position:[30.4833,76.5939]},
          {name:'Patiala', position:[30.3398,76.3869]}
        ],
        checkpoints: [[30.7,76.2]]
      },
      lineC: { // Bathinda -> Ludhiana via Mansa, Barnala
        name: 'Bathinda ‚Üî Ludhiana',
        color: '#8b5cf6',
        path: [
          [30.2110,74.9455], // Bathinda
          [29.9975,75.4010], // Mansa
          [30.3740,75.5480], // Barnala (approx)
          [30.9010,75.8573]  // Ludhiana
        ],
        stations: [
          {name:'Bathinda Jn', position:[30.2110,74.9455]},
          {name:'Mansa', position:[29.9975,75.4010]},
          {name:'Barnala', position:[30.3740,75.5480]},
          {name:'Ludhiana Jn', position:[30.9010,75.8573]}
        ],
        checkpoints: [[30.18,75.2],[30.55,75.7]]
      }
    };

    // Draw lines + stations
    const linePolylines = {};
    Object.keys(railLines).forEach(id=>{
      const LN = railLines[id];
      linePolylines[id] = L.polyline(LN.path, { color: LN.color, weight: 5, opacity: .75 }).addTo(map);
      LN.stations.forEach(st=>{
        const m = L.circleMarker(st.position, { radius: 5, fillColor: LN.color, color: '#fff', weight: 2, fillOpacity: .9 }).addTo(map);
        m.bindTooltip(st.name);
      });
    });

    /******** 2) Trains (mock GPS + occupancy) ********/
    const rndSpeed = () => 50 + Math.random()*25; // km/h trains
    const trains = [
      { id:'ASR-CHD-12001', lineId:'lineA', status:'On Time', position:0, direction:1, speedFactor:0.010, speedKmh:rndSpeed(), marker:null, lastLatLng:null, lastUpdate:Date.now(), occupancy:{count:430, capacity:700, confidence:0.86} },
      { id:'ASR-CHD-12003', lineId:'lineA', status:'Delayed by 7 mins', position:0.6, direction:1, speedFactor:0.009,  speedKmh:rndSpeed(), marker:null, lastLatLng:null, lastUpdate:Date.now(), occupancy:{count:640, capacity:700, confidence:0.71} },

      { id:'LDH-PTA-54321', lineId:'lineB', status:'On Time', position:0.2, direction:1, speedFactor:0.011, speedKmh:rndSpeed(), marker:null, lastLatLng:null, lastUpdate:Date.now(), occupancy:{count:210, capacity:600, confidence:0.92} },
      { id:'PTA-LDH-54322', lineId:'lineB', status:'On Time', position:1.4, direction:-1, speedFactor:0.010, speedKmh:rndSpeed(), marker:null, lastLatLng:null, lastUpdate:Date.now(), occupancy:{count:560, capacity:600, confidence:0.66} },

      { id:'BTI-LDH-77110', lineId:'lineC', status:'On Time', position:0.1, direction:1, speedFactor:0.012, speedKmh:rndSpeed(), marker:null, lastLatLng:null, lastUpdate:Date.now(), occupancy:{count:300, capacity:650, confidence:0.88} },
      { id:'LDH-BTI-77111', lineId:'lineC', status:'On Time', position:2.2, direction:-1, speedFactor:0.010, speedKmh:rndSpeed(), marker:null, lastLatLng:null, lastUpdate:Date.now(), occupancy:{count:620, capacity:650, confidence:0.62} }
    ];

    function trainIcon(color){
      return L.divIcon({ className:'train-icon', html:`<i class="fa-solid fa-train-subway" style="color:${color}; font-size:22px; text-shadow:0 0 3px #fff;"></i>`, iconSize:[24,24], iconAnchor:[12,12] });
    }
    trains.forEach(t=>{
      const LN = railLines[t.lineId];
      const start = LN.path[0];
      t.marker = L.marker(start, { icon: trainIcon(LN.color) }).addTo(map);
      t.marker.on('click', ()=> showTrainDetails(t));
    });

    /******** 3) Distance + ETA ********/
    const R_EARTH = 6371; const toRad = d=>d*Math.PI/180;
    function haversine(a,b){ const [lat1,lon1]=a,[lat2,lon2]=b; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const x=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R_EARTH*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)); }
    function interp(path,pos){ const i=Math.floor(pos), n=Math.min(i+1,path.length-1), f=pos-i; return [ path[i][0]+(path[n][0]-path[i][0])*f, path[i][1]+(path[n][1]-path[i][1])*f ]; }
    function distAlong(path,pos,targetIdx){
      let d=0; const i=Math.floor(pos); const fracPt=interp(path,pos);
      if(i<targetIdx){ d+=haversine(fracPt,path[i+1]); for(let k=i+1;k<targetIdx;k++) d+=haversine(path[k],path[k+1]); }
      else if(i>targetIdx){ d+=haversine(fracPt,path[i-1]); for(let k=i-1;k>targetIdx;k--) d+=haversine(path[k],path[k-1]); }
      else { d+=haversine(fracPt,path[targetIdx]); }
      return d;
    }
    function etaMinutes(train, stationIdx){
      const LN = railLines[train.lineId]; const dKm = distAlong(LN.path, train.position, stationIdx);
      const speed = Math.max(20, train.speedKmh);
      const min = (dKm / speed) * 60;
      if(/Delayed/.test(train.status)) return Math.round(min + 7);
      if(/Breakdown|Hold/.test(train.status)) return Infinity;
      return Math.round(min);
    }

    /******** 3b) Occupancy badge ********/
    function occStatus(occ){
      const pct = occ.capacity ? occ.count/occ.capacity : 0;
      if (pct >= 1.0) return {key:'FULL', label:'Full', icon:'‚õî', cls:'bg-gray-200 text-gray-800', pct};
      if (pct >= 0.85) return {key:'CROWDED', label:'Crowded', icon:'üî¥', cls:'bg-red-100 text-red-800', pct};
      if (pct >= 0.60) return {key:'BUSY', label:'Busy', icon:'üî∂', cls:'bg-amber-100 text-amber-800', pct};
      if (pct >= 0.30) return {key:'COMFORTABLE', label:'Comfortable', icon:'‚óºÔ∏è', cls:'bg-emerald-100 text-emerald-800', pct};
      return {key:'EMPTY', label:'Empty', icon:'‚óªÔ∏è', cls:'bg-green-100 text-green-800', pct};
    }
    function isCrowded(occ){ const k=occStatus(occ).key; return k==='CROWDED' || k==='FULL'; }
    function occBadgeHTML(occ){
      const st = occStatus(occ);
      const confPct = Math.round((occ.confidence ?? 0)*100);
      const aria = `${st.label}, ${occ.count} of ${occ.capacity} (${Math.round(st.pct*100)}%), confidence ${confPct}%`;
      const high = (occ.confidence ?? 0) >= 0.7;
      const dotCls = `w-2 h-2 rounded-full border ${high?'bg-black/70 border-black/70':'bg-black/20 border-black/50 border-dashed'}`;
      return `
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-xl text-xs font-medium ${st.cls}" role="status" aria-label="${aria}">
          <span>${st.icon} ${st.label}</span>
          <span class="opacity-75">${occ.count}/${occ.capacity}</span>
          <span class="${dotCls}" title="Confidence ${confPct}%"></span>
        </span>
      `;
    }

    /******** 4) Animation + Offline ********/
    let isOffline = false;
    function tickOcc(train){
      const o=train.occupancy; if(!o) return;
      const delta = Math.random()<0.5?-10:10; if(Math.random()<0.35) o.count += delta;
      o.count = Math.max(0, Math.min(o.capacity, o.count));
      const cJ=(Math.random()-0.5)*0.03; o.confidence = Math.max(0.3, Math.min(0.99, (o.confidence??0.8)+cJ));
    }
    function animate(){
      trains.forEach(t=>{
        const LN = railLines[t.lineId], path = LN.path;
        t.position += t.speedFactor * t.direction;
        const maxSeg = path.length-1;
        if(t.position >= maxSeg){ t.position=maxSeg; t.direction=-1; }
        else if(t.position <= 0){ t.position=0; t.direction=1; }
        const ll = interp(path, t.position); t.marker.setLatLng(ll);
        const now = Date.now();
        if(t.lastLatLng){
          const dtH=(now-t.lastUpdate)/3600000, dKm=haversine(t.lastLatLng,ll);
          const v=dKm/Math.max(0.0001,dtH); t.speedKmh = 0.8*t.speedKmh + 0.2*Math.min(110, Math.max(25, v));
        }
        t.lastLatLng=ll; t.lastUpdate=now;
        tickOcc(t);
      });
      requestAnimationFrame(animate);
    }
    animate();

    /******** 5) Service Tasks (Gender-based assignment) ********/
    const SERVICE_KEY='sarathi_rail_service_tasks';
    const loadTasks=()=>JSON.parse(localStorage.getItem(SERVICE_KEY)||'[]');
    const saveTasks=(arr)=>localStorage.setItem(SERVICE_KEY, JSON.stringify(arr));

    function nextArrivingTrain(lineId, stationIdx, {preferLessCrowded}={}){
      const rows = trains
        .filter(tr=>tr.lineId===lineId)
        .map(tr=>({train:tr, eta:etaMinutes(tr, stationIdx)}))
        .filter(r=>Number.isFinite(r.eta))
        .sort((a,b)=>a.eta-b.eta);
      if(!rows.length) return null;
      if(preferLessCrowded){
        const ok = rows.find(r=>!isCrowded(r.train.occupancy));
        if(ok) return ok;
      }
      return rows[0];
    }
    function assignTaskToNextTrain(task){
      const preferLessCrowded = task.gender==='female';
      const pick = nextArrivingTrain(task.lineId, task.stationIndex, {preferLessCrowded});
      if(!pick){ toast('No arriving trains found to assign.'); return null; }
      task.trainIdAssigned = pick.train.id;
      task.etaAssigned = pick.eta;
      task.status='queued';
      const arr=loadTasks(); arr.push(task); saveTasks(arr);
      toast(`Service assigned to ${pick.train.id} @ ${railLines[task.lineId].stations[task.stationIndex].name}`);
      return task;
    }
    function tasksFor(lineId, stationIdx, trainId){
      return loadTasks().filter(t => t.lineId===lineId && t.stationIndex===stationIdx && t.trainIdAssigned===trainId && t.status==='queued');
    }
    function serviceBadgeHTML(task){
      const icon = task.gender==='female' ? 'fa-venus' : (task.gender==='male' ? 'fa-mars' : 'fa-genderless');
      const tone = task.gender==='female' ? 'bg-pink-100 text-pink-800 border-pink-200'
                  : task.gender==='male' ? 'bg-blue-100 text-blue-800 border-blue-200'
                  : 'bg-slate-100 text-slate-800 border-slate-200';
      const catMap = { safety:'Safety/Escort', medical:'Medical Aid', assistance:'Assistance', cleanliness:'Cleanliness', coach:'Women Coach', other:'Other' };
      const cat = catMap[task.category] || 'Service';
      const aria = `${cat} requested for ${task.gender} passenger, assigned to next arriving train`;
      return `
        <span class="inline-flex items-center gap-2 px-2 py-1 rounded-lg text-xs border ${tone}" role="note" aria-label="${aria}" title="${cat} for ${task.gender}">
          <i class="fa-solid ${icon}"></i>
          <span class="font-medium">${cat}</span>
          <span class="opacity-70">ETA ~ ${task.etaAssigned}m</span>
        </span>
      `;
    }

    /******** 6) Train Details (with occupancy + next less-crowded suggestion + services) ********/
    function showTrainDetails(train){
      const panel=document.getElementById('details-panel');
      const info=document.getElementById('train-info');
      const LN=railLines[train.lineId];
      const statusClass = /Delayed|Hold/.test(train.status) ? 'text-red-600' : 'text-green-700';

      const stopsHTML = LN.stations.map((s, idx)=>{
        const eta=etaMinutes(train, idx);
        const etaStr = (eta===Infinity) ? '<span class="text-red-600">N/A</span>' : `${eta} min`;
        return `<li class="flex items-center justify-between gap-2">
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-800 text-white text-xs">${idx+1}</span>
            <span>${s.name}</span>
          </div>
          <span class="font-medium">${etaStr}</span>
        </li>`;
      }).join('');

      // Selected station context
      const selKey = document.getElementById('station-select').value;
      let suggestionHTML = '', serviceHTML = '';
      if(selKey){
        const [lid, idxStr] = selKey.split(':'); const stIdx = +idxStr;
        if(lid === train.lineId){
          // Services assigned to this train at selected station
          const pending = tasksFor(lid, stIdx, train.id);
          if(pending.length){
            serviceHTML = `
              <div class="mt-3 p-3 rounded-lg border border-pink-200 bg-pink-50" role="region" aria-label="Assigned services at selected station">
                <div class="text-sm font-semibold mb-1"><i class="fa-solid fa-bell-concierge mr-1"></i>Assigned Services @ <b>${LN.stations[stIdx].name}</b></div>
                <div class="flex flex-col gap-1">${pending.map(serviceBadgeHTML).join('')}</div>
              </div>`;
          }
          // If crowded, suggest next less-crowded arrival at this station
          if(isCrowded(train.occupancy)){
            const sameLine = trains
              .filter(tr=>tr.lineId===lid)
              .map(tr=>({train:tr, eta:etaMinutes(tr, stIdx), etaStr:etaMinutes(tr, stIdx)===Infinity?'N/A':`${etaMinutes(tr, stIdx)} min`}))
              .filter(r=>Number.isFinite(r.eta))
              .sort((a,b)=>a.eta-b.eta);
            const curEta = sameLine.find(r=>r.train.id===train.id)?.eta ?? Infinity;
            const alt = sameLine.find(r=> r.eta>curEta && !isCrowded(r.train.occupancy));
            if(alt){
              suggestionHTML = `
                <div class="mt-3 p-3 rounded-lg border border-amber-200 bg-amber-50" role="note" aria-label="Next less crowded train suggestion">
                  <div class="text-sm font-semibold mb-1"><i class="fa-solid fa-people-arrows mr-1"></i>Next arrival (less crowded)</div>
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <div class="text-sm font-medium">${alt.train.id}</div>
                      <div class="mt-1">${occBadgeHTML(alt.train.occupancy)}</div>
                    </div>
                    <div class="text-lg font-bold">${alt.etaStr}</div>
                  </div>
                </div>`;
            }
          }
        }
      }

      info.innerHTML = `
        <div class="p-3 bg-gray-100 rounded-lg space-y-1">
          <div class="font-bold text-lg">Train: ${train.id}</div>
          <div class="text-gray-700">Line: ${LN.name}</div>
          <div class="${statusClass} font-medium">Status: ${train.status}</div>
          <div class="text-gray-700">Speed: ${train.speedKmh.toFixed(1)} km/h</div>
          <div class="pt-2">
            <div class="text-gray-700 mb-1">Occupancy</div>
            <div>${occBadgeHTML(train.occupancy)}</div>
            ${suggestionHTML}
            ${serviceHTML}
          </div>
        </div>
        <div class="mt-4">
          <h3 class="font-bold text-lg mb-2">ETAs for upcoming stations</h3>
          <ul class="space-y-2">${stopsHTML}</ul>
        </div>
      `;
      panel.classList.add('open');
    }
    document.getElementById('close-panel').addEventListener('click',()=>document.getElementById('details-panel').classList.remove('open'));

    /******** 7) Filters ********/
    document.getElementById('line-filter').addEventListener('change', function(){
      const sel=this.value;
      trains.forEach(t=>{ if(sel==='all'||t.lineId===sel) t.marker.addTo(map); else t.marker.remove(); });
      Object.keys(linePolylines).forEach(id=>{ if(sel==='all'||id===sel) linePolylines[id].addTo(map); else linePolylines[id].remove(); });
      updateBoard();
    });

    /******** 8) Geolocation + Nearest Station ********/
    let userMarker=null, userCircle=null, currentUser=null;
    const geoOptions={ enableHighAccuracy:true, maximumAge:0, timeout:10000 };
    function updateUser(pos){
      const u=[pos.coords.latitude, pos.coords.longitude];
      currentUser=u;
      if(userMarker) userMarker.remove();
      if(userCircle) userCircle.remove();
      userMarker=L.marker(u,{icon:L.divIcon({className:'user', html:'<i class="fa-solid fa-user" style="color:#1d4ed8; font-size:20px; text-shadow:0 0 3px #fff;"></i>', iconSize:[20,20], iconAnchor:[10,10]})}).addTo(map);
      userCircle=L.circle(u,{radius:pos.coords.accuracy, color:'#1d4ed8', fillColor:'#1d4ed8', fillOpacity:.1}).addTo(map);
      map.setView(u, 11);
    }
    function locate(){ if(navigator.geolocation){ navigator.geolocation.getCurrentPosition(updateUser, e=>alert(e.message||'Failed to get location'), geoOptions); } else alert('Geolocation not supported'); }
    document.getElementById('locate-me').addEventListener('click', locate);

    function nearestStation(pt){
      let best={ st:null, lineId:null, dist:Infinity };
      Object.keys(railLines).forEach(lid=> railLines[lid].stations.forEach(s=>{
        const d=haversine(pt, s.position); if(d<best.dist) best={ st:s, lineId:lid, dist:d };
      }));
      return best;
    }
    let nsRoute=null;
    document.getElementById('nearest-station').addEventListener('click', ()=>{
      if(!currentUser){ alert("Use 'Locate Me' first"); return; }
      const best=nearestStation(currentUser);
      if(nsRoute) nsRoute.remove();
      nsRoute = L.polyline([currentUser, best.st.position], { color:'#1d4ed8', weight:4, opacity:.9, dashArray:'10,8' }).addTo(map);
      map.fitBounds(nsRoute.getBounds(), { padding:[40,40] });
      L.popup().setLatLng(best.st.position).setContent(`<div class="p-2">
        <div class="font-bold">Nearest Station</div>
        <div>${best.st.name}</div>
        <div>Line: ${railLines[best.lineId].name}</div>
        <div>Distance: ${best.dist.toFixed(2)} km</div>
      </div>`).openOn(map);
    });

    /******** 9) Station Display Board ********/
    const stationSelect=document.getElementById('station-select');
    (function fillStations(){
      Object.keys(railLines).forEach(lid=>{
        railLines[lid].stations.forEach((s,idx)=>{
          const opt=document.createElement('option'); opt.value=`${lid}:${idx}`; opt.textContent=`${s.name} ‚Äî ${railLines[lid].name}`;
          stationSelect.appendChild(opt);
        });
      });
    })();
    const board=document.getElementById('display-board');
    const boardBody=document.getElementById('board-body');
    document.getElementById('close-board').onclick=()=>board.classList.add('hidden');
    stationSelect.addEventListener('change', ()=>updateBoard(true));

    function updateBoard(force=false){
      const key=stationSelect.value; if(!key) return;
      const [lid, idxStr]=key.split(':'); const stIdx=+idxStr; const LN=railLines[lid];
      const filter=document.getElementById('line-filter').value;
      const list=[];
      trains.forEach(tr=>{
        if(tr.lineId!==lid) return;
        if(!(filter==='all'||tr.lineId===filter)) return;
        const eta=etaMinutes(tr, stIdx);
        list.push({tr, eta, etaStr: (eta===Infinity?'N/A':`${eta} min`)});
      });
      list.sort((a,b)=>a.eta-b.eta);

      boardBody.innerHTML = `
        <div class="text-xs text-gray-500 mb-1">Station: <b>${LN.stations[stIdx].name}</b> ¬∑ Line: ${LN.name}</div>
        ${list.slice(0,6).map((r, i)=>{
          const tasks = tasksFor(lid, stIdx, r.tr.id);
          const tasksHTML = tasks.length ? `<div class="mt-1 flex flex-wrap gap-1">${tasks.map(serviceBadgeHTML).join('')}</div>` : '';

          // If this train is crowded, suggest next less-crowded after it
          const alt = list.slice(i+1).find(x=>!isCrowded(x.tr.occupancy));
          const altHTML = isCrowded(r.tr.occupancy) ? `
            <div class="mt-2 p-2 rounded-md border border-amber-200 bg-amber-50" role="note" aria-label="Next less crowded suggestion">
              <div class="text-xs font-semibold mb-1"><i class="fa-solid fa-people-arrows mr-1"></i>Next arrival (less crowded)</div>
              ${alt ? `
                <div class="flex items-center justify-between gap-2">
                  <div>
                    <div class="text-xs font-medium">${alt.tr.id}</div>
                    <div class="mt-1">${occBadgeHTML(alt.tr.occupancy)}</div>
                  </div>
                  <div class="text-base font-bold">${alt.etaStr}</div>
                </div>` : `<div class="text-xs">No less crowded train soon.</div>`}
            </div>` : '';

          return `
          <div class="flex items-center justify-between border rounded-lg px-3 py-2">
            <div class="flex flex-col gap-0.5">
              <div class="font-medium flex items-center gap-2">
                <span>${r.tr.id}</span>
                <span class="text-xs text-gray-500">(Speed ${r.tr.speedKmh.toFixed(0)} km/h)</span>
              </div>
              <div class="text-xs ${/Delayed|Hold/.test(r.tr.status)?'text-amber-600':'text-emerald-700'}">${r.tr.status}</div>
              <div class="mt-1">${occBadgeHTML(r.tr.occupancy)}</div>
              ${tasksHTML}
              ${altHTML}
            </div>
            <div class="text-lg font-bold" aria-label="ETA ${r.etaStr}">${r.etaStr}</div>
          </div>`;
        }).join('')}
      `;
      if(force) board.classList.remove('hidden');
    }
    setInterval(()=>{ if(!board.classList.contains('hidden')) updateBoard(false); }, 3000);

    /******** 10) Offline ********/
    const offlineBtn=document.getElementById('toggle-offline');
    offlineBtn.addEventListener('click', ()=>{
      isOffline=!isOffline;
      offlineBtn.querySelector('span').textContent = isOffline ? 'Go Online' : 'Go Offline';
      offlineBtn.classList.toggle('bg-amber-700', isOffline);
      toast(isOffline?'Network lost (demo)':'Network restored');
    });

    /******** 11) Complaint / Service Modal ********/
    const modal=document.getElementById('complaint-modal');
    document.getElementById('open-complaint').onclick=()=>{ modal.classList.remove('hidden'); fillServiceSelectors(); };
    document.getElementById('close-complaint').onclick=()=>modal.classList.add('hidden');
    document.getElementById('cancel-complaint').onclick=()=>modal.classList.add('hidden');

    function fillServiceSelectors(){
      const lineSel=document.getElementById('cmp-line');
      const stSel=document.getElementById('cmp-station');
      lineSel.innerHTML=''; stSel.innerHTML='';
      Object.keys(railLines).forEach(lid=>{ const o=document.createElement('option'); o.value=lid; o.textContent=railLines[lid].name; lineSel.appendChild(o); });
      const fillStations=(lid)=>{ stSel.innerHTML=''; railLines[lid].stations.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=s.name; stSel.appendChild(o); }); };
      const first=Object.keys(railLines)[0]; fillStations(first);
      lineSel.onchange=e=>fillStations(e.target.value);

      // Prefill from board
      const key=stationSelect.value; if(key){ const [lid, idx]=key.split(':'); lineSel.value=lid; fillStations(lid); stSel.value=+idx; }
    }

    document.getElementById('complaint-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const task={
        id:'rail_svc_'+Date.now(),
        t:Date.now(),
        name:document.getElementById('cmp-name').value.trim(),
        gender:document.getElementById('cmp-gender').value,
        category:document.getElementById('cmp-category').value,
        desc:document.getElementById('cmp-desc').value.trim(),
        allowContact:document.getElementById('cmp-allow-contact').checked,
        lineId:document.getElementById('cmp-line').value,
        stationIndex:+document.getElementById('cmp-station').value,
        trainIdAssigned:null, etaAssigned:null, status:'queued'
      };
      assignTaskToNextTrain(task);
      modal.classList.add('hidden');
      updateBoard(true);
    });

    /******** 12) Toast ********/
    function toast(msg){
      const el=document.createElement('div');
      el.className='fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-lg shadow z-[1002]';
      el.textContent=String(msg); document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    }

    /******** 13) Tests (quick sanity) ********/
    const testPanel=document.getElementById('test-panel');
    const testList=document.getElementById('test-list');
    document.getElementById('test-close').onclick=()=>testPanel.classList.add('hidden');
    document.getElementById('run-tests').addEventListener('click', runTests);
    function addTest(name, ok, note=''){ const li=document.createElement('li'); li.innerHTML=`<span class="${ok?'bg-emerald-100 text-emerald-700':'bg-rose-100 text-rose-700'} test-badge">${ok?'PASS':'FAIL'}</span> <b>${name}</b> ${note?('‚Äì '+note):''}`; testList.appendChild(li); }
    function runTests(){
      testList.innerHTML=''; testPanel.classList.remove('hidden'); let fails=0;
      try{
        const keyBefore=SERVICE_KEY; localStorage.setItem(keyBefore,'[]');
        // Pref setup: make first of lineA crowded, second comfortable
        const a = trains.filter(t=>t.lineId==='lineA');
        if(a.length>=2){ a[0].occupancy.count = a[0].occupancy.capacity; a[1].occupancy.count = Math.round(a[1].occupancy.capacity*0.35); }

        // 1) Assign female request prefers less crowded
        const pick = assignTaskToNextTrain({ id:'T1', t:Date.now(), name:'Test', gender:'female', category:'safety', desc:'help', allowContact:true, lineId:'lineA', stationIndex:1, status:'queued' });
        const ok1 = !!pick && pick.trainIdAssigned && !isCrowded(trains.find(t=>t.id===pick.trainIdAssigned).occupancy);
        addTest('Gender-based assignment prefers less crowded', ok1); if(!ok1) fails++;

        // 2) Board render
        stationSelect.value='lineA:1'; updateBoard(true);
        const hasBoard = document.getElementById('board-body').innerHTML.includes('Next arrival (less crowded)') || document.getElementById('board-body').innerHTML.includes('Safety/Escort');
        addTest('Board renders suggestions/services', hasBoard); if(!hasBoard) fails++;

      }catch(e){ fails++; addTest('Unexpected error', false, e.message); console.error(e); }
      toast(fails?`Tests done ‚Äì ${fails} failing`:'All tests passed');
    }

    // Auto-run tests with ?test=1
    try { const p=new URLSearchParams(location.search); if(p.get('test')==='1') runTests(); } catch {}
  </script>
  <script>
  const labels = {};
  async function loadLanguage(lang) {
    const res = await fetch(`lang/${lang}.json`);
    Object.assign(labels, await res.json());
    document.querySelector('h1').textContent = labels.chooseMode;
    document.querySelectorAll('a')[0].textContent = 'üöç ' + labels.busTracking;
    document.querySelectorAll('a')[1].textContent = 'üöÜ ' + labels.trainTracking;
  }
  document.getElementById('lang-select').addEventListener('change', e => loadLanguage(e.target.value));
  loadLanguage('en'); // default
</script>
<script>
  const labels = {};

  async function loadLanguage(lang) {
    const res = await fetch(`lang/${lang}.json`);
    Object.assign(labels, await res.json());
    // Update top-level labels
    document.querySelector('h1').textContent = t('chooseMode');
    document.querySelectorAll('a')[0].textContent = 'üöç ' + t('busTracking');
    document.querySelectorAll('a')[1].textContent = 'üöÜ ' + t('trainTracking');

    // Update buttons that exist on this page
    const locateBtn = document.getElementById('locate-me');
    const complaintBtn = document.getElementById('open-complaint');
    if (locateBtn) locateBtn.textContent = t('locateMe');
    if (complaintBtn) complaintBtn.textContent = t('complaint');
  }

  // Translator function
  function t(key){ return labels[key] || key; }

  // Language selector event
  document.getElementById('lang-select')
    .addEventListener('change', e => loadLanguage(e.target.value));

  // Load default language on startup
  loadLanguage('en');
</script>


</body>
</html>
